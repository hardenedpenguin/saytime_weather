#!/bin/sh
set -e

# Create necessary directories
mkdir -p /var/cache/weather
mkdir -p /etc/asterisk/local

# Create the weather.ini file if it doesn't exist
CONFIG_FILE="/etc/asterisk/local/weather.ini"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Creating default configuration file: $CONFIG_FILE"
    cat <<'EOT' > "$CONFIG_FILE"
; ============================================================================
; Weather Configuration for saytime-weather
; ============================================================================
; This file controls how weather data is fetched and announced.
; All settings have sensible defaults - no changes required to get started!
; Command-line options override settings in this file for that run only.
; ============================================================================

[weather]

; ============================================================================
; TEMPERATURE SETTINGS
; ============================================================================

; Temperature display mode: F for Fahrenheit, C for Celsius
; Affects both temperature file output and displayed text.
; Valid values: F, C
; Default: F
Temperature_mode = F

; ============================================================================
; CONDITION ANNOUNCEMENTS
; ============================================================================

; Process and announce weather conditions (cloudy, rain, clear, etc.)
; Set to NO to only announce temperature (no condition sound files).
; Valid values: YES, NO
; Default: YES
process_condition = YES

; ============================================================================
; LOCATION SETTINGS
; ============================================================================

; Default country for ambiguous postal code lookups
; Helps with 5-digit codes that could be multiple countries (US, Germany, etc.)
; Use ISO 3166-1 alpha-2 country codes: us, ca, de, fr, uk, jp, au, etc.
; Leave blank for international search (slower, but more flexible).
; Valid values: ISO country code or blank
; Default: us
default_country = us

; ============================================================================
; WEATHER DATA SOURCE
; ============================================================================

; Weather data provider
;   openmeteo: Free, no API key, worldwide coverage (default)
;   nws:       Free, no API key, US locations only (official government data)
;              Automatically falls back to openmeteo for non-US locations
; Valid values: openmeteo, nws
; Default: openmeteo
weather_provider = openmeteo

; ============================================================================
; CACHE SETTINGS
; ============================================================================

; Enable caching to reduce API calls and improve response time
; Caching stores weather data locally to avoid repeated API calls.
; Recommended: YES (faster repeated lookups, reduces API load)
; Set to NO only for testing or if you need real-time updates every time.
; Valid values: YES, NO
; Default: YES
cache_enabled = YES

; Cache duration in seconds (how long to keep weather data)
; After this time, cached data expires and fresh data is fetched.
; Longer durations = fewer API calls but potentially stale data
; Shorter durations = more API calls but fresher data
; Valid values: Any positive integer (seconds)
; Default: 1800 (30 minutes)
cache_duration = 1800

; ============================================================================
EOT
    chmod 0644 "$CONFIG_FILE"
    echo "Default configuration file created."
else
    echo "Configuration file already exists: $CONFIG_FILE"
fi

# Set correct ownership
chown asterisk:asterisk /var/cache/weather
chown asterisk:asterisk /usr/share/asterisk/sounds/en/wx
chown asterisk:asterisk /usr/sbin/saytime.pl
chown asterisk:asterisk /usr/sbin/weather.pl

# Set correct permissions
chmod 755 /usr/sbin/saytime.pl
chmod 755 /usr/sbin/weather.pl
chmod 644 /usr/share/asterisk/sounds/en/wx/*
chmod 755 /var/cache/weather

#DEBHELPER#

case "$1" in
    configure)
        # Other post-installation tasks can go here
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

exit 0 